
## **Reranker-Distillation**

è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹

```bash
#åˆ‡æ¢è§£é‡Šå™¨
source .venv/bin/activate
cd Embedding-Distillation
# 1. è¿è¡Œ prepare.ipynb

# 2. ç”Ÿæˆlogitsdataview 
bash generate_logits.sh

# 3. åˆ›å»ºä¸‰å…ƒç»„è®­ç»ƒæ•°æ®
bash create_triplets.sh

# 4. è®­ç»ƒ
bash train.sh

# 5. è¯„ä¼°
bash evaluate.sh
```

**Reranker distillationæ•´ä½“æ­¥éª¤**

1. è¯´æ˜
    1. æ¨¡å‹æœ¬è´¨å°±æ˜¯cross-encoderï¼Œå³å°†QAè¿›è¡Œæ‹¼æ¥ï¼Œè¾“å…¥LLMè¿›è€Œå¾—åˆ°ç›¸ä¼¼åº¦ã€‚
2. generate_logits ç”Ÿæˆ59ä¸‡æ¡æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰ï¼Œè¿è¡Œæ—¶é•¿ï¼ˆ250minï¼‰ã€‚
    1. å³é’ˆå¯¹  query å’Œdoc ç”Ÿæˆä¸€ä¸ªlogprobåˆ†æ•°ï¼Œå³ `(query, passage, score)`ã€‚
    2. logprobåˆ†æ•°åˆ©ç”¨äº† promptæ¨¡æ¿ + LLMçš„chatæ¥å£ è¿›è¡Œæ‰“åˆ†ã€‚ promptæ¨¡æ¿å¦‚ä¸‹ã€‚
        1. `Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be "yes" or "no". `
        2. `<Instruct>: {instruction}\n<Query>: {query}\n<Document>: {doc}`
        3. å…¶ä¸­ instructå˜é‡ä¸º `Given a web search query, retrieve relevant passages that answer the query`
    3. prompt é™åˆ¶äº†è¾“å‡ºtokençš„èŒƒå›´ä¸º ä¸¤ä¸ªtoken ï¼ˆyes or noï¼‰ ã€‚
    4. æ¨ç†ä½¿ç”¨ vLLMçš„sdkï¼ŒåŠ è½½æœ¬åœ°æ¨¡å‹æ–‡ä»¶ã€‚
3. ä¸‰å…ƒç»„è’¸é¦æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰
    1. ç”Ÿæˆä¸‰å…ƒç»„è’¸é¦æ•°æ® `(query, positive passage, negative passage, logits_diff)`
    2. æ­£æ ·æœ¬ä¸ºlogits æœ€é«˜top_ké‡ŒæŠ½æ ·ã€‚
    3. è´Ÿæ ·æœ¬æŒ‰ç…§logitsæ’åº æ¯ä¸ªæ­£æ ·æœ¬ä½ç½®åé¢çš„æ ·æœ¬ã€‚
    4. å³ä¸¤ä¸¤ç»„åˆï¼Œç»„åˆæ•°é‡ä¸º `n*(n-1)/2`
    5. å¹¶éä½¿ç”¨è¯¥é¡¹ç›®æ•°æ®é›†çœŸæ­£çš„åŸå§‹ ground-truth labelã€‚
4. è®­ç»ƒ
    1. åˆ©ç”¨ embeddingå°æ¨¡å‹ + ä¸‰å…ƒç»„è’¸é¦æ•°æ® è¿›è¡Œè®­ç»ƒï¼Œå°†é¢†åŸŸçŸ¥è¯†è’¸é¦è¿›å°æ¨¡å‹ã€‚
5. è¯„ä¼°
    1. å¯¹å¾®è°ƒå‰çš„æ¨¡å‹å’Œå¾®è°ƒåçš„æ¨¡å‹åˆ©ç”¨æµ‹è¯•é›†æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚

```Python
# promptæ ¼å¼
message = [
    {"role": "system", "content": "Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be \"yes\" or \"no\"."},
    {"role": "user", "content": f"<Instruct>: {instruction}\n<Query>: {query}\n<Document>: {doc}"}
]

#LLMé‡‡æ ·å‚æ•°ï¼Œåªå…è®¸ yes å’Œ no é€‰é¡¹çš„logproè¾“å‡ºã€‚
    # å®šä¹‰å›ºå®šçš„ token å’Œé‡‡æ ·å‚æ•°
    true_token = tokenizer("yes", add_special_tokens=False).input_ids[0]
    false_token = tokenizer("no", add_special_tokens=False).input_ids[0]
    sampling_params = SamplingParams(
        temperature=0,
        max_tokens=1,
        logprobs=20,
        allowed_token_ids=[true_token, false_token],
    )
```

æ‰§è¡Œè¿‡ç¨‹


![alt text](Reranker-Distillation/image.png)


![alt text](Reranker-Distillation/image2.png)


![alt text](Reranker-Distillation/image3.png)


**rerankerè’¸é¦è¯„ä¼°ç»“æœ**

è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹

```bash
# reranker è’¸é¦è®­ç»ƒä¹‹åçš„è¯„ä¼°ç»“æœ
(rag-optimization-practices) root@dsw-1457330-845c588466-dwlc9:/mnt/workspace/large_model_demo/RAG/RAG-Level-02/P03-RAG-Optimization-Practices/Reranker-Distillation# bash evaluate.sh 
æ­£åœ¨ä» data/test.jsonl åŠ è½½æ•°æ®é›†...
åŠ è½½å®Œæˆï¼å…± 2992 æ¡æ ·æœ¬ã€‚

--- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-reranker-v2-m3 ---
--- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: ./output/checkpoint-1217 ---
==================================================
âœ… æœ€ç»ˆè¯„ä¼°ç»“æœæ±‡æ€»
==================================================

ã€è’¸é¦å‰ã€‘æ¨¡å‹æ€§èƒ½:
  - MAP: 0.472061
  - MRR@10: 0.478234
  - NDCG@10: 0.547284

ã€è’¸é¦åã€‘æ¨¡å‹æ€§èƒ½:
  - MAP: 0.564523
  - MRR@10: 0.573106
  - NDCG@10: 0.638634
==================================================
ğŸš€ æ€§èƒ½å˜åŒ–åˆ†æ (è’¸é¦å vs. è’¸é¦å‰)
==================================================
æŒ‡æ ‡ [MAP]:
  - ç»å¯¹æå‡: +0.092462
  - ç›¸å¯¹æå‡: +19.59% â†‘
æŒ‡æ ‡ [MRR@10]:
  - ç»å¯¹æå‡: +0.094872
  - ç›¸å¯¹æå‡: +19.84% â†‘
æŒ‡æ ‡ [NDCG@10]:
  - ç»å¯¹æå‡: +0.091349
  - ç›¸å¯¹æå‡: +16.69% â†‘
è¯„ä¼°å®Œæˆï¼âœ¨
```



## **Embedding-Distillation**

```bash
#åˆ‡æ¢è§£é‡Šå™¨
source .venv/bin/activate
cd Embedding-Distillation
# 1. è¿è¡Œ prepare.ipynb

# 2. ç”Ÿæˆlogitsdataview 
bash generate_logits.sh

# 3. åˆ›å»ºä¸‰å…ƒç»„è®­ç»ƒæ•°æ®
bash create_triplets.sh

# 4. è®­ç»ƒ
bash train.sh

# 5. è¯„ä¼°
bash evaluate.sh
```

**embedding æ¨¡å‹è’¸é¦è¿‡ç¨‹**

  1. è¯´æ˜
      1. æ¨¡å‹å…¶å®å°±æ˜¯bi-encoderï¼Œå³æ¨¡å‹è¾“å‡ºembeddingï¼Œç„¶åè®¡ç®—QAç›¸ä¼¼åº¦ã€‚
      2. [ç”¨KLæ•£åº¦å°†Qwen3-Embedding-8Bå‘é‡å¤§æ¨¡å‹çŸ¥è¯†è’¸é¦ç»™å°æ¨¡å‹BGE-m3 - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/1933693856077026394)
  2. generate_logits
      1. é’ˆå¯¹åŸå§‹æ•°æ®ä¸­æ¯ä¸€è¡Œä¸­çš„ ä¸€ä¸ªqueryã€å¤šä¸ªpositiveæ–‡æ¡£ã€å¤šä¸ªnegativeæ–‡æ¡£ åˆ†åˆ«è¾“å…¥ Qwen3-embeddingæ¨¡å‹ï¼Œå¾—åˆ°å‘é‡ã€‚
      2. é’ˆå¯¹æ•°æ®å½¢å¼ `ï¼ˆqueryï¼ŒpositiveDocï¼Œ[negativeDoc,negativeDoc2ï¼Œ...]ï¼‰`ï¼Œåˆ†åˆ«è®¡ç®—queryå’Œæ¯ä¸ªdocçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œç„¶åå°† æ‰€æœ‰çš„ç›¸ä¼¼åº¦ è§†ä¸ºä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒã€‚
  3. train.sh
      1. å¯¹äºå­¦ç”Ÿæ¨¡å‹åŒæ ·äº§ç”Ÿä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œå’Œè€å¸ˆæ¨¡å‹çš„åˆ†å¸ƒè®¡ç®—KLæŸå¤±ï¼Œè¿›è€Œè®­ç»ƒå­¦ç”Ÿæ¨¡å‹ã€‚
  4. è¯„ä¼°
      1. åˆ©ç”¨é¢„ç•™çš„æµ‹è¯•é›†è¿›è¡Œè¯„ä¼°ã€‚


![alt text](Embedding-Distillation/image.png)


**embeddingè’¸é¦è¯„ä¼°ç»“æœ**

```Python
(rag-optimization-practices) root@dsw-1457330-845c588466-dwlc9:/mnt/workspace/large_model_demo/RAG/RAG-Level-02/P03-RAG-Optimization-Practices/Embedding-Distillation# bash evaluation.sh 
============================================================
æ¨¡å‹æ€§èƒ½å¯¹æ¯”è¯„ä¼°
============================================================

------------------------------
é¢†åŸŸå†…æ•°æ®é›†è¯„ä¼°
------------------------------

æ­£åœ¨åŠ è½½æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-m3
æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_scidocs/test.jsonl
æˆåŠŸåŠ è½½ 3978 æ¡æ ·æœ¬
å¼€å§‹è¯„ä¼°...
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 63/63 [00:06<00:00,  9.34it/s]
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1854/1854 [03:29<00:00,  8.85it/s]

æ­£åœ¨åŠ è½½æ¨¡å‹: output/checkpoint-477
æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_scidocs/test.jsonl
æˆåŠŸåŠ è½½ 3978 æ¡æ ·æœ¬
å¼€å§‹è¯„ä¼°...
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 63/63 [00:06<00:00,  9.28it/s]
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1854/1854 [03:34<00:00,  8.63it/s]

------------------------------
é¢†åŸŸå¤–æ•°æ®é›†è¯„ä¼°
------------------------------

æ­£åœ¨åŠ è½½æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-m3
æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_stackoverflowdupquestions/test.jsonl
æˆåŠŸåŠ è½½ 2992 æ¡æ ·æœ¬
å¼€å§‹è¯„ä¼°...
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:04<00:00, 10.51it/s]
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1398/1398 [01:56<00:00, 12.03it/s]

æ­£åœ¨åŠ è½½æ¨¡å‹: output/checkpoint-477
æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_stackoverflowdupquestions/test.jsonl
æˆåŠŸåŠ è½½ 2992 æ¡æ ·æœ¬
å¼€å§‹è¯„ä¼°...
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:04<00:00, 10.15it/s]
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1398/1398 [01:57<00:00, 11.88it/s]

============================================================
é¢†åŸŸå†…æ•°æ®é›† æ€§èƒ½å¯¹æ¯”
============================================================
æŒ‡æ ‡                 è’¸é¦å‰         è’¸é¦å        ç»å¯¹å˜åŒ–     ç›¸å¯¹å˜åŒ–(%)
------------------------------------------------------------
map             0.7744      0.8516     +0.0773       +9.98
mrr@10          0.9321      0.9548     +0.0227       +2.43
ndcg@10         0.8296      0.8956     +0.0660       +7.96

============================================================
é¢†åŸŸå¤–æ•°æ®é›† æ€§èƒ½å¯¹æ¯”
============================================================
æŒ‡æ ‡                 è’¸é¦å‰         è’¸é¦å        ç»å¯¹å˜åŒ–     ç›¸å¯¹å˜åŒ–(%)
------------------------------------------------------------
map             0.5166      0.5034     -0.0132       -2.56
mrr@10          0.5238      0.5110     -0.0127       -2.43
ndcg@10         0.5902      0.5778     -0.0124       -2.10

è¯„ä¼°å®Œæˆ
```








-----------------

é¡¹ç›®åŸå§‹æ–‡æ¡£

# RAG ä¼˜åŒ–å®è·µ (RAG Optimization Practices)
<p align="center">
Â  <a href="https://pytorch.org/" target="_blank"> <img src="https://img.shields.io/badge/PyTorch-2.6-red.svg" alt="PyTorch Version"></a>
  <a href="https://www.sbert.net/" target="_blank"> <img src="https://img.shields.io/badge/Sentence--Transformers-5.0-blue.svg" alt="Sentence-Transformers Version"></a>
</p>

## ğŸš€ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ—¨åœ¨åˆ†äº« **RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) ä¼˜åŒ–** çš„å®è·µç»éªŒã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
/RAG-Optimization-Practices
â”œâ”€â”€ ğŸ“„ README.md                         <-- ä½ æ­£åœ¨çœ‹çš„ä¸»é¡µ
â”‚      
â”œâ”€â”€ ğŸ“ Reranker-Distillation/             (âœ… å·²å®Œæˆ)
â”‚   â”œâ”€â”€ README.md                       # Reranker è’¸é¦æ¨¡å—çš„è¯¦ç»†è¯´æ˜
â”‚   â”œâ”€â”€ generate_logits.sh              # æ­¥éª¤1: æ•™å¸ˆæ¨¡å‹ç”ŸæˆLogitåˆ†æ•°
â”‚   â”œâ”€â”€ create_triplets.sh              # æ­¥éª¤2: æ„å»ºè®­ç»ƒæ ·æœ¬
â”‚   â”œâ”€â”€ train.sh                        # æ­¥éª¤3: è®­ç»ƒå­¦ç”Ÿæ¨¡å‹
â”‚   â””â”€â”€ evaluation.sh                   # æ­¥éª¤4: è¯„æµ‹æ€§èƒ½
â”‚
â”œâ”€â”€ ğŸ“ Embedding-Distillation/            (âœ… å·²å®Œæˆ)
â”‚   â”œâ”€â”€ README.md                       # Embedding è’¸é¦æ¨¡å—çš„è¯¦ç»†è¯´æ˜
â”‚   â”œâ”€â”€ generate_distillation_data.sh   # æ­¥éª¤1: æ•™å¸ˆæ¨¡å‹ç”Ÿæˆè’¸é¦åˆ†æ•°
â”‚   â”œâ”€â”€ train.sh                        # æ­¥éª¤2: è®­ç»ƒå­¦ç”Ÿæ¨¡å‹
â”‚   â””â”€â”€ evaluation.sh                   # æ­¥éª¤3: è¯„æµ‹æ€§èƒ½
â”‚
â”œâ”€â”€ ğŸ“ Query-Expansion-RL/                (â³ è§„åˆ’ä¸­)
â””â”€â”€ ğŸ“ Milvus-Optimization/               (â³ è§„åˆ’ä¸­)
```

-----

## âœ… å·²å®Œæˆæ¨¡å—

### æ¨¡å—ä¸€ï¼šReranker çŸ¥è¯†è’¸é¦

æœ¬é¡¹ç›®çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œå®è·µå¦‚ä½•å°†SOTAé‡æ’åºæ¨¡å‹ï¼ˆæ•™å¸ˆæ¨¡å‹ï¼š`Qwen3-Reranker-8B`ï¼‰çš„çŸ¥è¯†åœ°è’¸é¦åˆ°ä¸€ä¸ª 0.6B çš„è½»é‡çº§æ¨¡å‹ï¼ˆå­¦ç”Ÿæ¨¡å‹ï¼š`BAAI/bge-reranker-v2-m3`ï¼‰ä¸Šã€‚

#### æ ¸å¿ƒæˆæœï¼šæ€§èƒ½æ˜¾è‘—æå‡

ä¸ä¾èµ–äººå·¥æ ‡æ³¨ï¼Œé€šè¿‡çŸ¥è¯†è’¸é¦ï¼Œå­¦ç”Ÿæ¨¡å‹åœ¨ `stackoverflowdupquestions-reranking` æ•°æ®é›†ä¸Šçš„æ€§èƒ½è·å¾—äº†**è¿‘ 20% çš„ç›¸å¯¹æå‡**ã€‚

| æŒ‡æ ‡ (Metric) | è’¸é¦å‰ (åŸå§‹) | è’¸é¦å (ä¼˜åŒ–) | ç»å¯¹æå‡ | **ç›¸å¯¹æå‡** |
| :--- | :---: | :---: | :---: | :---: |
| **MAP** | 0.4721 | **0.5653** | +0.0932 | **+19.76%** ğŸš€ |
| **MRR@10** | 0.4782 | **0.5738** | +0.0956 | **+19.98%** ğŸš€ |
| **NDCG@10** | 0.5473 | **0.6390** | +0.0917 | **+16.76%** ğŸš€ |

ğŸ‘‰ **ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å®ç°ã€ä»£ç å’Œå¤ç°æ­¥éª¤: [./Reranker-Distillation/README.md](https://github.com/kanhaoning/RAG-Optimization-Practices/tree/main/Reranker-Distillation/README.md)**


### æ¨¡å—äºŒï¼šEmbedding çŸ¥è¯†è’¸é¦

æœ¬é¡¹ç›®çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œå®è·µå¦‚ä½•å°†SOTAå‘é‡æ¨¡å‹ï¼ˆæ•™å¸ˆæ¨¡å‹ï¼š`Qwen3-Embedding-8B`ï¼‰çš„çŸ¥è¯†è’¸é¦åˆ°ä¸€ä¸ª 0.6B çš„è½»é‡çº§æ¨¡å‹ï¼ˆå­¦ç”Ÿæ¨¡å‹ï¼š`BAAI/bge-m3`ï¼‰ä¸Šï¼Œæ—¨åœ¨æå‡å…¶åœ¨ç‰¹å®šé¢†åŸŸçš„æ’åºèƒ½åŠ›ã€‚

#### æ ¸å¿ƒæˆæœï¼šé¢†åŸŸå†…æ€§èƒ½æå‡10%ï¼Œä¸”ç¼“è§£é¢†åŸŸå¤–ç¾éš¾æ€§é—å¿˜

é€šè¿‡åŸºäºKLæ•£åº¦çš„çŸ¥è¯†è’¸é¦ï¼Œå­¦ç”Ÿæ¨¡å‹åœ¨ `scidocs` è¿™ä¸€ç§‘å­¦æ–‡æ¡£æ•°æ®é›†ä¸Šçš„ **MAP æŒ‡æ ‡ç›¸å¯¹æå‡äº† 10.20%**ï¼ŒåŒæ—¶åœ¨é¢†åŸŸå¤–æ•°æ®é›†ä¸Šçš„æ€§èƒ½ä¸‹é™å¹…åº¦æ§åˆ¶åœ¨ 2.5% ä»¥å†…ï¼Œç¼“è§£äº†ç¾éš¾æ€§é—å¿˜ã€‚

| æŒ‡æ ‡ (Metric) | è’¸é¦å‰ (åŸå§‹) | è’¸é¦å (ä¼˜åŒ–) | ç»å¯¹æå‡ | **ç›¸å¯¹æå‡** |
| :--- | :---: | :---: | :---: | :---: |
| **MAP** | 0.7744 | **0.8534** | +0.0790 | **+10.20%** ğŸš€ |
| **MRR@10** | 0.9321 | **0.9554** | +0.0233 | +2.50% |
| **NDCG@10** | 0.8296 | **0.8973** | +0.0676 | +8.15% |

ğŸ‘‰ **ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å®ç°ã€ä»£ç å’Œå¤ç°æ­¥éª¤: [./Embedding-Distillation/README.md](https://github.com/kanhaoning/RAG-Optimization-Practices/tree/main/Embedding-Distillation/README.md)**
